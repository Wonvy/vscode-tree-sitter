# Tree-Sitter Outline 调试功能说明

## 新增功能

### 1. 时间戳调试信息

每次加载函数大纲时，都会在输出通道中显示详细的时间戳信息：

```
[14:30:25] 🔍 getChildren 被调用，元素: root
[14:30:25] 🔍 处理文档，语言: javascript, 文件: /path/to/file.js
[14:30:25] ✅ 开始解析文档: /path/to/file.js
[14:30:25] 🔍 开始解析文档: /path/to/file.js
[14:30:25] 📝 语言: javascript
[14:30:25] 🔧 解析器状态: 已创建
[14:30:25] 📄 源代码长度: 1234 字符
[14:30:25] 🌳 解析树: 成功
[14:30:25] 🌱 根节点类型: program
[14:30:25] 👶 子节点数量: 5
[14:30:25] 📊 提取的函数数量: 3
[14:30:25] 🎯 生成的轮廓项数量: 3
[14:30:30] ✅ 函数大纲加载完成！共 3 个项目
```

### 2. 函数大纲状态检测

#### 命令：`tree-sitter-outline.checkStatus`

在命令面板中执行此命令可以检查函数大纲的加载状态：

**使用方法：**
1. 按 `Ctrl+Shift+P` 打开命令面板
2. 输入 "Tree-sitter Outline: 检查函数大纲状态"
3. 执行命令

**输出信息：**
```
📊 函数大纲状态详情:
  - 已初始化: ✅
  - 有函数: ✅
  - 有大纲项: ✅
  - 函数数量: 3
  - 大纲项数量: 3
  - 当前语言: javascript
  - 解析器状态: 已创建
  - 总体状态: ✅ 已加载
```

### 3. 失去焦点问题修复

**问题描述：**
之前当编辑器失去焦点时，函数大纲会消失，因为 `getChildren` 方法依赖于 `vscode.window.activeTextEditor`。

**解决方案：**
- 添加了 `getLastActiveEditor()` 方法
- 当没有活动编辑器时，尝试获取最后活动的编辑器
- 支持从可见编辑器和工作区文档中获取编辑器信息
- 即使失去焦点也能保持函数大纲显示

**实现逻辑：**
1. 首先尝试获取当前活动编辑器
2. 如果没有，尝试从可见编辑器中获取
3. 如果都没有，尝试从工作区文档中创建虚拟编辑器
4. 确保函数大纲始终有内容显示

## 使用方法

### 启用调试模式

在 `src/config.ts` 中设置：
```typescript
enableVerboseLogging: true,
showFunctionNotFoundWarning: true
```

### 检查状态

使用命令面板执行状态检查命令，或直接调用：
```typescript
const status = outlineProvider.getOutlineStatus();
const isLoaded = outlineProvider.isOutlineLoaded();
```

### 查看详细日志

在VS Code的输出面板中选择 "Tree-sitter Outline" 通道，查看详细的调试信息。

## 调试信息说明

### 时间戳格式
- 格式：`[HH:MM:SS]`
- 每次操作都有独立的时间戳
- 便于追踪操作顺序和耗时

### 状态指示符
- ✅ 成功/正常
- ❌ 失败/错误
- ⚠️ 警告/注意
- 🔍 调试/检查
- 📊 统计信息
- 🌳 解析树相关
- 📝 文档相关

### 关键节点
- **初始化阶段**：Tree-Sitter 初始化状态
- **语言设置**：当前支持的语言和切换
- **文档解析**：源代码解析过程
- **函数提取**：函数信息提取结果
- **大纲生成**：最终大纲项数量
- **加载完成**：整体加载状态

## 故障排除

### 常见问题

1. **函数大纲不显示**
   - 执行状态检查命令
   - 查看输出通道的详细日志
   - 确认文档语言是否支持

2. **解析失败**
   - 检查Tree-Sitter初始化状态
   - 确认WASM文件是否正确加载
   - 查看解析树结构诊断信息

3. **性能问题**
   - 调整刷新延迟参数
   - 启用防抖机制
   - 减少不必要的日志输出

### 调试步骤

1. 执行状态检查命令
2. 查看输出通道日志
3. 确认文档语言支持
4. 检查初始化状态
5. 分析解析树结构
6. 验证函数提取结果

## 注意事项

- 调试信息会增加输出量，生产环境建议关闭
- 时间戳有助于性能分析和问题定位
- 状态检查命令可以随时执行，不影响正常功能
- 失去焦点修复确保了大纲的持久性显示 