# Tree-Sitter Outline 高亮功能调试说明

## 问题描述

用户反馈：编辑器中鼠标点击函数所在行，函数大纲无法高亮对应的函数名称。

## 修复方案

### 1. 增强调试信息

在每个关键步骤都添加了详细的时间戳调试信息：

```
[14:30:25] 🖱️ 光标位置变化: 行 15
[14:30:25] 🔄 行号变化: 10 -> 15
[14:30:25] ⏰ 延迟后开始高亮处理...
[14:30:25] 🎯 开始高亮第 15 行对应的函数...
[14:30:25] 📊 当前状态检查:
[14:30:25]   - 函数数量: 3
[14:30:25]   - 大纲项数量: 3
[14:30:25]   - 已初始化: ✅
[14:30:25] 🧹 清除之前的高亮...
[14:30:25] 🔍 查找第 15 行对应的OutlineItem...
[14:30:25] 📊 总共有 3 个OutlineItem
[14:30:25] 🔍 检查项目: main (行 1-20)
[14:30:25] ✅ 行号 15 在范围内！
[14:30:25] ✅ 找到匹配的OutlineItem: main (行 1-20)
[14:30:25] 🎨 设置高亮状态...
[14:30:25] ✅ 高亮设置成功
[14:30:25] 🔍 确保父节点展开...
[14:30:25] 🔄 刷新UI显示高亮...
[14:30:25] 🎉 高亮完成！函数: main
```

### 2. 光标变化监听优化

- 添加了50ms延迟，确保光标位置稳定后再处理
- 详细的日志记录，便于追踪问题
- 智能跳过重复的行号变化

### 3. OutlineItem查找增强

- 递归查找逻辑的详细日志
- 显示所有OutlineItem的行号范围
- 匹配失败时的详细诊断信息

### 4. 高亮状态验证

- 验证高亮是否设置成功
- 使用更明显的高亮效果
- 添加高亮标识到描述中

## 新增调试命令

### 1. 检查函数大纲状态
**命令**: `tree-sitter-outline.checkStatus`
**功能**: 检查函数大纲的加载状态和详细信息

### 2. 测试高亮功能
**命令**: `tree-sitter-outline.testHighlight`
**功能**: 手动测试当前行的高亮功能

## 使用方法

### 启用详细日志

在 `src/config.ts` 中设置：
```typescript
enableVerboseLogging: true,
showFunctionNotFoundWarning: true
```

### 测试高亮功能

1. 将光标放在函数内的任意行
2. 按 `Ctrl+Shift+P` 打开命令面板
3. 输入 "Tree-sitter Outline: 测试高亮功能"
4. 执行命令
5. 查看函数大纲面板是否高亮对应函数

### 查看调试信息

在VS Code的输出面板中选择 "Tree-sitter Outline" 通道，查看详细的调试信息。

## 调试步骤

### 1. 基本检查
- 执行状态检查命令
- 确认函数大纲已加载
- 验证当前文档语言支持

### 2. 高亮测试
- 执行高亮测试命令
- 查看调试日志输出
- 检查函数大纲面板

### 3. 问题诊断
- 分析日志中的错误信息
- 检查OutlineItem的行号范围
- 验证光标位置变化监听

## 常见问题

### 1. 高亮不显示
**可能原因**:
- 函数大纲未加载
- OutlineItem行号范围不匹配
- UI刷新失败

**解决方法**:
- 执行状态检查命令
- 查看详细调试日志
- 手动测试高亮功能

### 2. 高亮闪烁
**可能原因**:
- 光标位置频繁变化
- 重复的高亮处理

**解决方法**:
- 检查光标变化监听器
- 调整延迟时间
- 优化防抖机制

### 3. 高亮错位
**可能原因**:
- 行号计算错误
- OutlineItem范围不准确

**解决方法**:
- 验证行号转换逻辑
- 检查OutlineItem创建过程
- 对比实际代码行数

## 性能优化

### 1. 延迟处理
- 光标变化后50ms延迟处理
- 避免频繁的高亮操作
- 减少不必要的UI刷新

### 2. 智能跳过
- 跳过重复的行号变化
- 避免重复的高亮设置
- 优化资源使用

### 3. 条件日志
- 根据配置显示日志
- 生产环境可关闭详细日志
- 平衡调试和性能

## 注意事项

- 调试信息会增加输出量，生产环境建议关闭
- 高亮功能依赖于函数大纲的正确加载
- 光标位置变化监听器需要稳定的编辑器状态
- 手动测试命令可以绕过自动触发机制

## 预期效果

修复后的高亮功能应该能够：
1. 正确响应鼠标点击和光标变化
2. 准确高亮对应的函数名称
3. 提供详细的调试信息
4. 稳定可靠地工作
5. 支持手动测试和诊断 