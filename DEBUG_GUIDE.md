# Tree-Sitter Outline 调试指南

## 问题描述
函数大纲没有被选中的问题通常表现为：
- 在编辑器中移动光标时，函数大纲中的对应项没有高亮显示
- 点击函数大纲项时，编辑器没有跳转到对应位置
- TreeView的选中状态与实际光标位置不同步

## 新增调试功能

### 1. 调试TreeView状态命令
**命令ID**: `tree-sitter-outline.debugTreeView`
**功能**: 检查TreeView的完整状态信息
**使用方法**: 
1. 按 `Ctrl+Shift+P` 打开命令面板
2. 输入 "调试TreeView状态"
3. 选择并执行命令
4. 查看输出面板中的详细信息

**输出信息包括**:
- 基本状态（初始化状态、函数数量、大纲项数量等）
- TreeView状态（绑定状态、抑制标志、当前选中项等）
- 当前文档信息（文件名、语言、行数、光标位置等）

### 2. 强制刷新TreeView选中状态命令
**命令ID**: `tree-sitter-outline.forceRefreshSelection`
**功能**: 强制刷新TreeView的选中状态，修复选中问题
**使用方法**:
1. 按 `Ctrl+Shift+P` 打开命令面板
2. 输入 "强制刷新TreeView选中状态"
3. 选择并执行命令

### 3. 增强的日志输出
所有关键操作都会在输出面板中记录详细的日志信息，包括：
- 时间戳
- 操作类型
- 成功/失败状态
- 错误详情

## 调试步骤

### 步骤1: 检查基本状态
1. 执行 "调试TreeView状态" 命令
2. 确认以下状态：
   - ✅ 已初始化
   - ✅ 函数数量 > 0
   - ✅ 大纲项数量 > 0
   - ✅ TreeView已绑定

### 步骤2: 检查光标同步
1. 在编辑器中移动光标到不同的函数
2. 观察输出面板中的日志：
   - 光标位置变化是否被检测到
   - 是否找到了对应的函数
   - 高亮操作是否执行成功

### 步骤3: 检查TreeView选中
1. 执行 "强制刷新TreeView选中状态" 命令
2. 观察输出面板中的日志：
   - TreeView.reveal 是否执行成功
   - 选中状态验证是否通过
   - 目标项是否被正确选中

### 步骤4: 分析问题原因
根据日志信息，常见问题包括：

#### 问题1: TreeView未绑定
**症状**: `TreeView未绑定，无法选中`
**解决**: 重启VSCode或重新加载扩展

#### 问题2: 函数大纲未加载
**症状**: `函数大纲未加载完成`
**解决**: 等待文档解析完成，或手动刷新大纲

#### 问题3: 抑制标志未正确重置
**症状**: `抑制标志已设置，跳过光标变化处理`
**解决**: 等待120ms后自动重置，或执行强制刷新命令

#### 问题4: TreeView.reveal执行失败
**症状**: `TreeView.reveal 执行失败`
**解决**: 检查TreeView状态，可能需要重新绑定

## 常见问题解决方案

### 问题: 光标移动时大纲不跟随
**解决方案**:
1. 检查光标变化监听器是否正常工作
2. 确认当前行是否在已加载函数范围内
3. 检查抑制标志状态

### 问题: 点击大纲项不跳转
**解决方案**:
1. 检查跳转命令是否正确注册
2. 确认OutlineItem的行号信息是否正确
3. 验证文档URI是否匹配

### 问题: TreeView选中状态不同步
**解决方案**:
1. 执行强制刷新选中状态命令
2. 检查TreeView绑定状态
3. 确认抑制标志是否正确管理

## 性能优化建议

1. **减少日志频率**: 光标变化日志已优化为3秒间隔
2. **延迟处理**: 用户点击操作延迟200ms，正常移动延迟100ms
3. **抑制机制**: 避免循环触发，提高响应性能

## 联系支持

如果问题仍然存在，请：
1. 收集完整的调试日志
2. 记录问题复现步骤
3. 提供VSCode版本和扩展版本信息
4. 在GitHub上提交issue

---

**注意**: 这些调试功能主要用于开发和问题排查，生产环境中建议适当减少日志输出。 